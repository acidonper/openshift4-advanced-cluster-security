# Red Hat Advanced Cluster Security for Kubernetes

This repository includes a set of resources and information for starting in Red Hat Advanced Cluster Security for Kubernetes

## Prerequisites

- Openshift 4.6+
- _Roxctl_ Cli (*Please find information about Roxctl CLI installation bellow*)

## Install RockCLI

_Roxctl_ Cli is a binary that allows users to perform some actions via command line. In order to install this CLI, please following the next steps:


```$bash

## LINUX

curl -O https://mirror.openshift.com/pub/rhacs/assets/3.69.0/bin/Linux/roxctl

chmod +x roxctl

sudo mv roxctl /usr/local/bin

roxctl version
```

NOTE: For more information visit [Getting started with the roxctl CLI](https://docs.openshift.com/acs/3.69/cli/getting-started-cli.html#installing-roxctl-cli)

## Setting Up RHACS (*All in one*)

First at all, it is required to install the operator that facilitates users to install the *RHACS Solution* easily and behind a GitOps model.

Please execute the following commands in order to install the RHACS Kubernetes Operator:

```$bash
oc new-project rhacs-operator

oc apply -f 00-rhacs-install-operator.yaml -n rhacs-operator

oc get pods -n rhacs-operator
NAME                                                 READY   STATUS    RESTARTS   AGE
rhacs-operator-controller-manager-67487c958f-xqv6b   2/2     Running   0          29m
```

### Install **RHACS Central Component** (*For more information [RHACS Central Documentation]()*)

Once the operator is up and running, it is time to deploy the *RHACS Central Component*, named *RHACS Control Plane*, following the next steps:

```$bash
oc new-project stackrox

oc apply -f 01-rhacs-install-central.yaml -n stackrox

oc get pods -n stackrox
NAME                         READY   STATUS    RESTARTS   AGE
central-6b96668d45-nq9b5     1/1     Running   0          2m28s
scanner-7d77d75f6c-dq8h4     1/1     Running   0          2m28s
scanner-7d77d75f6c-m4phx     1/1     Running   0          2m28s
scanner-7d77d75f6c-m6h84     1/1     Running   0          2m28s
scanner-db-77dd49d98-85cnn   1/1     Running   0          2m28s
```

CENTRAL: Central is the main component of Red Hat Advanced Cluster Security for Kubernetes and it is installed as a Kubernetes deployment. It handles data persistence, API interactions, and user interface (Portal) access. You can use the same Central instance to secure multiple OpenShift Container Platform or Kubernetes clusters.

SCANNER: Red Hat Advanced Cluster Security for Kubernetes includes an image vulnerability scanning component called Scanner. It analyzes all image layers to check for known vulnerabilities from the Common Vulnerabilities and Exposures (CVEs) list. Scanner also identifies vulnerabilities in packages installed by package managers and in dependencies for multiple programming languages.

Once the RHACS control plane is installed, it is time for testing the RHACS Central Component via Web UI (User: admin / Password: _autogenerated_)

```$bash
oc get route -n stackrox
NAME           HOST/PORT                                         PATH   SERVICES   PORT    TERMINATION   WILDCARD
central        central-stackrox.apps.pd.sandbox225.opentlc.com          central    https   passthrough   None
central-mtls   central.stackrox                                         central    https   passthrough   None

oc -n stackrox get secret central-htpasswd -o go-template='{{index .data "password" | base64decode}}'
```

### Generate an Init Bundle

This step produces a bundle file with a set of kubernetes resources that are required to connect *Secured Clusters* to the *RHACS Central Component or Control Plane*.

Please execute the following commands and save the output file securely:

```$bash
ROX_CENTRAL_ADDRESS=$(oc -n stackrox get route central -o jsonpath='{.spec.host}')
ROX_CENTRAL_ADMIN_PASS=$(oc -n stackrox get secret central-htpasswd -o go-template='{{index .data "password" | base64decode}}')

roxctl -e "${ROX_CENTRAL_ADDRESS}" -p "${ROX_CENTRAL_ADMIN_PASS}" central init-bundles generate init_bundle --output-secrets cluster_init_bundle.yaml --insecure-skip-tls-verify
```


### Install **Secured Cluster**

Once the previous steps are performed, it is time to connect *Secured Clusters* to the *RHACS Central Component or Control Plane* in order to star securing Kubernetes clusters.

Please follow the next step to secure the Openshift Cluster that hosts the *RHACS Central Component*:

- Creating resources by using the init bundle

```$bash
oc create -f cluster_init_bundle.yaml -n stackrox
```

- Create *Secured Cluster* object in order to deploy the components

```$bash
oc apply -f 02-rhacs-install-secured-cluster.yaml

oc get pods
NAME                                 READY   STATUS    RESTARTS   AGE
admission-control-6f6fd7c7f7-jgjr8   1/1     Running   0          119s
admission-control-6f6fd7c7f7-ndpn7   1/1     Running   0          119s
admission-control-6f6fd7c7f7-sd54g   1/1     Running   0          119s
collector-7qrpk                      2/2     Running   0          119s
collector-8g4nl                      2/2     Running   0          119s
collector-9fdbq                      2/2     Running   0          119s
collector-gvp6h                      2/2     Running   0          119s
collector-mssjd                      2/2     Running   0          119s
collector-pfrgw                      2/2     Running   0          119s
collector-wq5h2                      2/2     Running   0          119s
sensor-7579588d86-prtkz              1/1     Running   0          119s
```

SENSOR: Red Hat Advanced Cluster Security for Kubernetes uses the Sensor component to monitor Kubernetes and OpenShift Container Platform clusters. It handles interactions with the OpenShift Container Platform or Kubernetes API server for policy detection and enforcement, and it coordinates with Collector.

ADMISSION CONTROLLER: The admission controller prevents users from creating workloads that violate security policies in Red Hat Advanced Cluster Security for Kubernetes.

COLLECTOR: Collector collects and monitors information about container runtime and network activity. It then sends the collected information to Sensor. (*Installed in each OCP Node*)

## Author

Asier Cidon (@RedHat)